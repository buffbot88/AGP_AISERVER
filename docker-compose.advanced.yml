version: '3.8'

# Advanced docker-compose configuration with HTTPS, custom networking, and monitoring
# This example demonstrates production-ready deployment with security features

services:
  ashataiserver:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: ashataiserver:latest
    container_name: ashataiserver-prod
    ports:
      - "7077:7077"    # HTTP
      - "7443:7443"    # HTTPS (optional)
    volumes:
      # Model files (read-only for security)
      - ./models:/app/models:ro
      
      # Persistent data (database, logs)
      - ./data:/app/data
      
      # TLS certificates (if using HTTPS)
      - ./certs:/app/certs:ro
      
      # Optional: Custom appsettings
      # - ./appsettings.Production.json:/app/appsettings.Production.json:ro
    environment:
      # Core server configuration
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=https://+:7443;http://+:7077
      
      # Paths
      - ModelsDirectory=/app/models
      - Database__Path=/app/data/users.db
      
      # TLS Configuration
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/app/certs/certificate.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=${CERT_PASSWORD}
      
      # Rate limiting (adjust for your needs)
      - RateLimit__RequestsPerMinute=100
      - RateLimit__RequestsPerHour=5000
      - RateLimit__Enabled=true
      
      # API Key protection (recommended for production)
      - ApiKey__RequireForEndpoints=true
      - ApiKey__ProtectedPaths=/api/ai/process,/api/ai/generate-project
      
      # Logging
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      - Logging__LogLevel__ASHATAIServer=Debug
      
      # CORS (restrict in production)
      - Cors__AllowedOrigins=https://yourdomain.com,https://app.yourdomain.com
      
      # Runtime configuration
      - LlamaCpp__ExecutablePath=/usr/local/bin/llama-cli
      - Runtime__Type=MockRuntime
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:7443/api/ai/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - ashat-network
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp

  # Optional: Reverse proxy with automatic HTTPS
  nginx:
    image: nginx:alpine
    container_name: ashataiserver-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - ashataiserver
    networks:
      - ashat-network
    restart: unless-stopped
    profiles:
      - with-proxy

networks:
  ashat-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  data:
    driver: local
  models:
    driver: local
